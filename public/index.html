<!DOCTYPE html>
<html>
<head>
  <title>Recipe App</title>
  <style>
    table { border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button { margin: 0 5px; }
  </style>
</head>
<body>
  <h1>My Recipes</h1>
  <form action="/recipes" method="POST">
    <input type="text" name="title" placeholder="Recipe Name"><br>
    <input type="text" name="ingredients" placeholder="Ingredients (e.g., 2 cups flour, 1 tsp salt)"><br>
    <button type="submit">Add Recipe</button>
  </form>
  <ul id="recipe-list"></ul>
  <h2>Meal Plan</h2>
  <button onclick="showWeekView()">Week View</button>
  <button onclick="showMonthView()">Month View</button>
  <div id="meal-plan"></div>
  <script>
    function loadRecipes() {
      fetch('/recipes')
        .then(response => response.json())
        .then(recipes => {
          const list = document.getElementById('recipe-list');
          list.innerHTML = '';
          recipes.forEach(recipe => {
            const li = document.createElement('li');
            li.textContent = recipe.title;
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => deleteRecipe(recipe.id);
            li.appendChild(deleteBtn);
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => editRecipe(recipe.id, recipe.title, recipe.ingredients);
            li.appendChild(editBtn);
            const planBtn = document.createElement('button');
            planBtn.textContent = 'Plan';
            planBtn.onclick = () => planRecipe(recipe.id);
            li.appendChild(planBtn);
            if (recipe.ingredients.length > 0) {
              const ul = document.createElement('ul');
              recipe.ingredients.forEach(ing => {
                const ingLi = document.createElement('li');
                ingLi.textContent = `${ing.quantity} ${ing.unit} ${ing.name}`;
                ul.appendChild(ingLi);
              });
              li.appendChild(ul);
            }
            list.appendChild(li);
          });
        })
        .catch(err => console.log('Fetch Error:', err));
    }

    function getWeekDates() {
      const today = new Date();
      const start = new Date(today);
      start.setDate(today.getDate() - today.getDay()); // Start on Sunday
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);
      }
      return dates;
    }

    function getMonthDates() {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const dates = [];
      for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
        dates.push(d.toISOString().split('T')[0]);
      }
      return dates;
    }

    function loadMealPlan(startDate, endDate, isMonth = false) {
      fetch(`/meals?startDate=${startDate}&endDate=${endDate}`)
        .then(response => response.json())
        .then(meals => {
          const planDiv = document.getElementById('meal-plan');
          planDiv.innerHTML = '';
          const dates = isMonth ? getMonthDates() : getWeekDates();
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tbody = document.createElement('tbody');
          const headerRow = document.createElement('tr');
          dates.forEach(date => {
            const th = document.createElement('th');
            th.textContent = isMonth ? date.split('-')[2] : date; // Day for month, full date for week
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          const row = document.createElement('tr');
          dates.forEach(date => {
            const td = document.createElement('td');
            const meal = meals.find(m => m.date === date);
            td.textContent = meal ? meal.recipe_title : '-';
            row.appendChild(td);
          });
          tbody.appendChild(row);
          table.appendChild(thead);
          table.appendChild(tbody);
          planDiv.appendChild(table);
        })
        .catch(err => console.log('Fetch Error:', err));
    }

    function showWeekView() {
      const dates = getWeekDates();
      loadMealPlan(dates[0], dates[6]);
    }

    function showMonthView() {
      const dates = getMonthDates();
      loadMealPlan(dates[0], dates[dates.length - 1], true);
    }

    function deleteRecipe(recipeId) {
      fetch(`/recipes/${recipeId}`, { method: 'DELETE' })
        .then(response => {
          if (response.ok) {
            loadRecipes();
            showWeekView(); // Default to week view after delete
          } else {
            console.log('Delete failed');
          }
        })
        .catch(err => console.log('Delete Error:', err));
    }

    function editRecipe(recipeId, currentTitle, currentIngredients) {
      const title = prompt('Edit recipe title:', currentTitle);
      if (title === null) return;
      const ingredientsStr = currentIngredients.map(ing => `${ing.quantity} ${ing.unit} ${ing.name}`).join(', ');
      const ingredients = prompt('Edit ingredients (comma-separated):', ingredientsStr);
      if (ingredients === null) return;
      fetch(`/recipes/${recipeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, ingredients })
      })
      .then(response => {
        if (response.ok) {
          loadRecipes();
          showWeekView();
        } else {
          console.log('Edit failed');
        }
      })
      .catch(err => console.log('Edit Error:', err));
    }

    function planRecipe(recipeId) {
      const date = prompt('Enter date (YYYY-MM-DD):');
      if (date) {
        fetch('/meals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipe_id: recipeId, date: date })
        })
        .then(response => {
          if (response.ok) {
            showWeekView();
          } else {
            console.log('Plan failed');
          }
        })
        .catch(err => console.log('Plan Error:', err));
      }
    }

    loadRecipes();
    showWeekView(); // Start with week view
  </script>
</body>
</html>