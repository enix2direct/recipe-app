<!DOCTYPE html>
<html>
<head>
  <title>Recipe App</title>
</head>
<body>
  <h1>My Recipes</h1>
  <form action="/recipes" method="POST">
    <input type="text" name="title" placeholder="Recipe Name"><br>
    <input type="text" name="ingredients" placeholder="Ingredients (e.g., 2 cups flour, 1 tsp salt)"><br>
    <button type="submit">Add Recipe</button>
  </form>
  <ul id="recipe-list"></ul>
  <h2>Meal Plan</h2>
  <ul id="meal-plan"></ul>
  <script>
    function loadRecipes() {
      fetch('/recipes')
        .then(response => response.json())
        .then(recipes => {
          const list = document.getElementById('recipe-list');
          list.innerHTML = '';
          recipes.forEach(recipe => {
            const li = document.createElement('li');
            li.textContent = recipe.title;
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => deleteRecipe(recipe.id);
            li.appendChild(deleteBtn);
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => editRecipe(recipe.id, recipe.title, recipe.ingredients);
            li.appendChild(editBtn);
            const planBtn = document.createElement('button');
            planBtn.textContent = 'Plan';
            planBtn.onclick = () => planRecipe(recipe.id);
            li.appendChild(planBtn);
            if (recipe.ingredients.length > 0) {
              const ul = document.createElement('ul');
              recipe.ingredients.forEach(ing => {
                const ingLi = document.createElement('li');
                ingLi.textContent = `${ing.quantity} ${ing.unit} ${ing.name}`;
                ul.appendChild(ingLi);
              });
              li.appendChild(ul);
            }
            list.appendChild(li);
          });
        })
        .catch(err => console.log('Fetch Error:', err));
    }

    function loadMealPlan() {
      fetch('/meals')
        .then(response => response.json())
        .then(meals => {
          const planList = document.getElementById('meal-plan');
          planList.innerHTML = '';
          meals.forEach(meal => {
            const li = document.createElement('li');
            li.textContent = `${meal.date}: ${meal.recipe_title}`;
            planList.appendChild(li);
          });
        })
        .catch(err => console.log('Fetch Error:', err));
    }

    function deleteRecipe(recipeId) {
      fetch(`/recipes/${recipeId}`, { method: 'DELETE' })
        .then(response => {
          if (response.ok) {
            loadRecipes();
            loadMealPlan();
          } else {
            console.log('Delete failed');
          }
        })
        .catch(err => console.log('Delete Error:', err));
    }

    function editRecipe(recipeId, currentTitle, currentIngredients) {
      const title = prompt('Edit recipe title:', currentTitle);
      if (title === null) return; // Cancelled
      const ingredientsStr = currentIngredients.map(ing => `${ing.quantity} ${ing.unit} ${ing.name}`).join(', ');
      const ingredients = prompt('Edit ingredients (comma-separated):', ingredientsStr);
      if (ingredients === null) return; // Cancelled
      fetch(`/recipes/${recipeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, ingredients })
      })
      .then(response => {
        if (response.ok) {
          loadRecipes();
        } else {
          console.log('Edit failed');
        }
      })
      .catch(err => console.log('Edit Error:', err));
    }

    function planRecipe(recipeId) {
      const date = prompt('Enter date (YYYY-MM-DD):');
      if (date) {
        fetch('/meals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipe_id: recipeId, date: date })
        })
        .then(response => {
          if (response.ok) {
            loadMealPlan();
          } else {
            console.log('Plan failed');
          }
        })
        .catch(err => console.log('Plan Error:', err));
      }
    }

    loadRecipes();
    loadMealPlan();
  </script>
</body>
</html>